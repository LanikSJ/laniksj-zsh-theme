name: Test ZSH Theme
permissions:
  contents: read

on:
  push:
    branches: [ main, master ]
    paths:
      - '*.zsh-theme'
  pull_request:
    branches: [ main, master ]
    paths:
      - '*.zsh-theme'
  workflow_dispatch:

jobs:
  test-zsh-theme:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
    - name: Checkout Repository
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: Set up ZSH (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y zsh

    - name: Set up ZSH (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install zsh

    - name: Set up kubectl
      uses: azure/setup-kubectl@776406bce94f63e41d621b960d78ee25c8b76ede # v4.0.1
      with:
        version: 'v1.28.0'
      continue-on-error: true

    - name: Install oh-my-zsh for Git Prompt Functionality
      run: |
        sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
        echo 'export PATH="$HOME/.oh-my-zsh/bin:$PATH"' >> ~/.bashrc

    - name: Test ZSH Theme Loading Without kubectl
      run: |
        zsh --version

        # Start ZSH with theme
        zsh -c '
        echo "Testing theme loading..."
        source ./laniksj.zsh-theme
        echo "Theme loaded successfully"

        # Test kubeoff (default state)
        echo "Testing kubeoff..."
        echo "PROMPT before: $PROMPT" | head -c 100
        kubeoff
        echo "Prompt set to kubeoff"

        # Test kubeon (should work even without kubectl)
        echo "Testing kubeon..."
        kubeon
        echo "Prompt set to kubeon"

        echo "All basic tests passed!"
        '

    - name: Test ZSH Theme With kubectl (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        timeout 30s zsh -c '
        echo "Testing with kubectl if available..."
        source ./laniksj.zsh-theme

        if command -v kubectl >/dev/null 2>&1; then
          echo "kubectl found - testing with kubernetes enabled"

          # Create a test kubeconfig (in-memory only)
          export KUBECONFIG=/tmp/test-kubeconfig
          kubectl config set-context test-context --cluster=test-cluster --user=test-user
          kubectl config use-context test-context

          # Test kubeon with kubectl
          kubeon

          # Check if context is detected
          if [[ $KUBE_PS1_ENABLED == "on" ]]; then
            echo "Kubernetes prompt enabled successfully"
          else
            echo "ERROR: Kubernetes prompt not enabled"
            exit 1
          fi

          echo "Kubernetes tests passed!"
        else
          echo "kubectl not available - skipping kubectl-specific tests"
        fi
        '

    - name: Test ZSH Theme With kubectl (macOS)
      if: runner.os == 'macOS'
      run: |
        zsh -c '
        echo "Testing with kubectl if available..."
        source ./laniksj.zsh-theme

        if command -v kubectl >/dev/null 2>&1; then
          echo "kubectl found - testing with kubernetes enabled"

          # Create a test kubeconfig (in-memory only)
          export KUBECONFIG=/tmp/test-kubeconfig
          kubectl config set-context test-context --cluster=test-cluster --user=test-user
          kubectl config use-context test-context

          # Test kubeon with kubectl
          kubeon

          # Check if context is detected
          if [[ $KUBE_PS1_ENABLED == "on" ]]; then
            echo "Kubernetes prompt enabled successfully"
          else
            echo "ERROR: Kubernetes prompt not enabled"
            exit 1
          fi

          echo "Kubernetes tests passed!"
        else
          echo "kubectl not available - skipping kubectl-specific tests"
        fi
        '

    - name: Test Error Handling
      run: |
        zsh -c '
        echo "Testing error handling..."
        source ./laniksj.zsh-theme

        # Remove kubectl if it exists
        if command -v kubectl >/dev/null 2>&1; then
          echo "kubectl found - removing temporarily"
          mv $(which kubectl) $(which kubectl).backup 2>/dev/null || true
        fi

        # Test that theme works without kubectl
        kubeon
        echo "Theme works without kubectl"

        kubeoff
        echo "Theme functions work without kubectl"

        # Restore kubectl
        mv $(which kubectl).backup $(which kubectl) 2>/dev/null || true
        '

    - name: Verify Theme File Syntax
      run: |
        echo "Checking ZSH syntax..."
        zsh -n ./laniksj.zsh-theme || { echo "Syntax error in theme file"; exit 1; }
        echo "Theme syntax is valid"
